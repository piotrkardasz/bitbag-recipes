#Copy from https://github.com/symfony/recipes/blob/main/.github/workflows/callable-flex-update.yml
name: Update Flex endpoint

on:
  workflow_call:
    inputs:
      branch:
        default: main
        required: false
        type: string
      contrib:
        required: false
        type: boolean
      versions_json:
        required: false
        type: string

jobs:
  flex-update:
    name: Update Flex endpoint
    runs-on: Ubuntu-20.04

    steps:
      -
        name: Checkout
        uses: actions/checkout@v2
        id: checkout
        with:
          fetch-depth: 0

      -
        name: Install tools
        run: |
          git config --global user.email ""
          git config --global user.name "github-action[bot]"
          cd .github
          wget -q -O recipes-checker.zip https://codeload.github.com/symfony-tools/recipes-checker/zip/refs/heads/main
          unzip recipes-checker.zip
          cd recipes-checker-main
          wget -q -O GenerateFlexEndpointCommand.patch https://raw.githubusercontent.com/piotrkardasz/bitbag-recipes/workflows/patches/GenerateFlexEndpointCommand.patch
          patch src/GenerateFlexEndpointCommand.php GenerateFlexEndpointCommand.patch
          composer install --ansi --no-dev
      -
        name: Update Flex endpoint
        run: |
          mkdir .github/flex-endpoint
          git ls-tree HEAD */*/* | php .github/recipes-checker-main/run generate:flex-endpoint ${{ github.repository }} ${{ inputs.branch }} flex/main .github/flex-endpoint ${{ inputs.versions_json }} ${{ inputs.contrib && '--contrib' || '' }}
          git switch flex/main
          git rm -q *.json
          mv .github/flex-endpoint/*.json .
          git add *.json
          git commit -m 'Update Flex endpoint' || true
          git push origin -f flex/main
